[TOC]

## Alpha多样性

### Alpha多样性概念和常用指数

物种多样性主要从三个层面进行衡量，分别是α多样性、β多样性和γ多样性。每个衡量尺度所呈现的多样性角度不同。Alpha多样性也被称为生境内多样性（within-habitat diversity），是指一个特定区域或生态系统内的多样性。以医学领域为例，α多样性是指一个样本中物种的多少、丰度和均匀度（图1）。我们用动物园来打个形象的比喻，α多样性是指这个动物园中动物的种类数、每种动物的只数和每种动物数量的平衡关系。β多样性又称生境间多样性（between-habitat diversity），是指生境群落之间物种组成的相异性或物种沿环境梯度更替的速率。同样以医学领域为例，它主要指样本间物种组成的相异性（图1）。β多样性相当于2个动物园中动物种类的差异情况。γ多样性是指一个区域内总的多样性，由于其在微生物组研究中极少使用，此处不作介绍。

![image](http://210.75.224.110/github/MicrobiomeStatPlot/01AlphaBoxplot/alpha_diversity_Qian2020CMJ.jpg)

图1. α多样性和β多样性示意图(Qian, 2020)。α多样性主要体现样本内物种多少、丰度和/或均匀度，而β多样性指样本间多样性异同。

α多样性的计算主要与3个因素有关：一是物种数目（richness），二是丰度（abundance），三是均匀度（evenness）。物种数目是指一个样本中物种存在的个数，与每个物种量的多寡无关。丰度是指每个物种的多寡，比如一个粪便样本中物种A出现10次，物种B出现1000次；如果将每个样本所有物种求百分比，这样每个样本的物种丰度合计数为1，这种丰度叫相对丰度。均匀度主要考量物种之间的相对比例。α多样性常用的衡量指标有：

- 观察到的物种数（Observed OTU/ASV）：是指每个样本中能够观察到的OTU或ASV的数量，与每个OTUs或ASVs的多寡无关。如果把动物园比喻成一个样本，则“Observed OTUs”是指这个动物园中动物的种类数，与每种动物具体有几只无关。

- Chao1指数：是物种数目的衡量标准之一，它考虑3个因素，一是物种数目，二是只有1条序列的物种数目，三是2条序列的物种数目，计算公式是：Schao1=Sobs+n1(n1-1)/2(n2+1)，其中Schao1为估计的OTU数，Sobs为观测到的OTU数，n1为只有1条序列的OTU数目，n2为只有2条序列的OTU数目。Chao1指数越大，表明某群落物种数目较多。注意，从公式可以看出，Chao1指数受1条和2条序列的物种影响较大。

- 基于丰度的覆盖估计值（Abundance-based Coverage Estimator, ACE）：是用来估计群落中含有OTU 数目的指数，同样由Chao提出(Chao and Yang, 1993)，是生态学中估计物种总数的常用指数之一。默认将序列量10以下的OTU都计算在内，从而估计群落中实际存在的物种数。ACE指数越大，表明群落中物种数目越大。

- 香农指数（Shannon-Wiener index）：香农指数综合考虑了群落的物种数目和均匀度这两个因素。Shannon指数值越高，表明群落的α多样性越高。注意，该指标对于丰度低的物种有较大的权重，即计算时受丰度低的物种影响较大，在解释香农指数时需要注意这点。

- 辛普森指数（Simpson index）：用来估算样品中微生物的多样性指数之一，由Edward Hugh Simpson ( 1949) 提出。Simpson 指数值越大，说明群落多样性越低。辛普森指数在计算时将丰度高的物种设置了较大权重，所以高峰度物种较多时该指数值较大，这与香农指数有明显区别。

- Pielou’s均匀度指数（Pielou’s Evenness Index）：这是最常用的均匀度指数，它其实就是香农指数与Observed OTU/ASV对数的比值。很显然，这个指标受Observed OTU/ASV影响很大，这是这个指标的主要缺点之一。由于香农指数和辛普森指数本身就包含了均匀度信息，实际研究工作中这2个指标更常用。

### 认识箱线图

箱形图（Box-plot）又称为盒须图、盒式图或箱线图，是一种用作显示一组数据分散情况资料的统计图。因形状如箱子而得名。在宏基因组领域，常用于展示样品组中各样品Alpha多样性的分布。

下面两张图参考自斯坦福医学统计课程第一单元第三节，PPT32-33页，中文翻译参考百度百科。直接上图。

- 第一种情况：最大或最小值没有超过1.5倍箱体范围；

![image](http://210.75.224.110/github/MicrobiomeStatPlot/01AlphaBoxplot/boxprinciple1.png)

图1. 以Alpha多样性最常用的香农指数(Shannon index)为例

- 第二种情况：最大或最小值超过1.5倍箱体范围，外位延长线外，即异常值(outliers)：

![image](http://210.75.224.110/github/MicrobiomeStatPlot/01AlphaBoxplot/boxprinciple2.png)

图2. 以Alpha多样性丰富度指数(Richness index)为例

### 箱线图实例解读

1. Nature Biotechnology 2019 图1e

此文章是中科院遗传发育所白洋团队于2019年发表于国际技术类顶级期刊Naute Biotechnology(简称NBT，IF<sup>2018</sup> = 31.864)的文章，介绍了水稻群体层面微生物组的研究并揭示了宿主机制调控根系微生物参与氮利用的现象。详细内容参见中文解读原文：- [《NBT封面：水稻NRT1.1B基因调控根系微生物组参与氮利用》](https://mp.weixin.qq.com/s/s7Q1_MeodqJ0hjwDumeiXQ)。

在这里，我们选择了文章中包含alpha多样性的描述性语句，方便大家更好的使用alpha多样性结果。然而我们也必须注意，alpha作为一个经典和古老的指标，在如今的微生物组学发展中已经不是核心指标了，所以刘老师这篇文章在讨论种并未对alpha多样性进行讨论，但是却对于下游微生物数据的分析方向有着重要的指导意义。

我们的学习思路是每个图提供图、图注和结果的描述，带领大家庖丁解牛式的学习每一种图的展示样式、图注内容和结果描述的中、英文表达方式，并批注一些注意事项、相关经验和套路的总结。使读者不仅看懂图，会写图注、写结果。最后提供参考代码绘制个性化的图表，让你独立完成科学论文中的每一部分，并能更好地传递科学发现。

![image](http://210.75.224.110/github/MicrobiomeStatPlot/01AlphaBoxplot/2019NBT.fig1e.png)

**图3**. 箱线图展示籼粳稻和土壤的香农多样性指数。箱体上中下线分别为75、50(中位数)和25分位数，轴须线最长不超过1.5x箱体范围。字母用于区分组间是否存在显著区别，不同字母表示组间存在显示差异(*P* < 0.05，ANOVA, Tukey-HSD test)。图中的样本量如下：地块1：籼稻 (*n* = 201), 粳稻 (*n* = 80), 土壤 (*n* = 12); 地块2, 籼稻 (*n* = 201), 粳稻 (*n* = 81), 土壤 (*n* = 12)。

> Shannon index of the microbiota of roots from indica, japonica and the corresponding bulk soils in two fields. The horizontal bars within boxes represent medians. The tops and bottoms of boxes represent the 75th and 25th percentiles, respectively. The upper and lower whiskers extend to data no more than 1.5× the interquartile range from the upper edge and lower edge of the box, respectively. The numbers of replicated samples in this figure are as follows: in field I, *indica* (*n* = 201), *japonica* (*n* = 80), soil (*n* = 12); in field II, *indica* (*n* = 201), *japonica* (*n* = 81), soil (*n* = 12).

图注描述注意事项：

1. 图表标题写法有两类，第一个类写做了什么(如本例)，另一类是写发现的结果(如A比B多)，以第一类使用较多，第二类更突出发现的规律但有时杂志不允许；
2. 箱线图要对箱体的上、中、下水平线，两端延长线的位置和意义进行描述。虽然是固定套路，但Nature系列杂志要求必须描述清楚；
3. 样本数量要在图注结果详细描述，每个实验组的样本量(*n* = xxx)，其中n要任何，等号两边要有空格；如果 *n* < 30，必须在箱线图中添加抖动图(jitter)展示每个样本点的分布位置。


**结果**：粳稻和籼稻的根系微生物的alpha多样性具有显著差异(图1e和附图4)。两块地中粳稻根系微生物多样性显著高于粳稻(图1e)，表明粳稻根系可以招募更多微生物种类。

> Measurement of within-sample diversity (α-diversity) revealed a significant difference between indica and japonica varieties
(Fig. 1e and Supplementary Fig. 4). The root microbiota of
indica had higher diversity than those of japonica in both fields
(Fig. 1e), indicating that indica roots recruited more bacterial species
than japonica rice.

结果描述注意事项：

1. 一般提到显著(significant)就必须要描述准确的P值和统计方法，如(*P* = 0.03 或 *P* < 0.05，ANOVA和Tukey HSD test等方法)，但有时篇幅有限和感觉重复，只在方法部分定义，结果和图注中会省略，注意*P*要斜体，<前后有空格。
2. 结果一般是图中信息的描述、比较和规律总结，有图时且已经发现了规律，写起来是非常容易的，要注意尽量陈述事实而不要过度引深或推断。


2. Gut Microbes 2020 图1

这是南医大刘星吟团队发表在Gut Microbes(简称NBT，IF<sup>2018</sup> = 7.823)的文章，本研究揭示了肠道微生物谱的改变与孤独症谱系障碍的异常神经递质代谢活动相关。详细内容参见原文解读[《Gut Microbes：南医大刘星吟团队揭示肠道微生物与孤独症相关》](https://mp.weixin.qq.com/s/9eJN5i7rfUluRVgsOf7rqw)。

![image](http://210.75.224.110/github/MicrobiomeStatPlot/01AlphaBoxplot/2020GutMicrobes.fig1hij.png)

图4. 基于年龄梯度的α多样性系数分析，包括丰富度估计量指数（H）、香农指数（I）和系统发育多样性指数（1J。

**附图注原文：**
> (h), Shannon index (i), and phylogenetic diversity index (j). 


**result** : 我们进一步评估了与年龄有关的
细菌alpha多样性的变化。不同的alpha多样性指数仅反映了样本内多样性的一个方面。因此，我们使用三种方法来估算两组之间与年龄相关的alpha多样性变化。如图1（h）所示，物种丰富度（breakaway estimates）显示出
TD组的7-11岁年龄组与2-3岁的年龄组不同；然而，ASD组没有显示出随着年龄增长而变化。香农指数解释存在物种的丰度和均匀性。如图1（i）所示，4-6岁年龄组的香农指数和2-3岁年龄组想比没有显着性
有所变化，但在TD组的7至11岁年龄组的Shannon指数显示出增加。系统发育多样性（PD）指数用于衡量两组之间的进化多样性差异程度。如图1（j）所示，相比与2-3岁亚组，4-6岁亚组的PD指数和TD组的7-11岁均增加。

> We further assessed the age-related
change of bacteria diversity. Different alpha diversity index reflects only one aspect of within-sample diversity; hence, we used three methods to estimate
the age-related change in alpha diversity between the two groups. As shown in Figure 1(h), the richness of species (breakaway estimates) showed increased in
7–11 years age subgroup of TD group compared to 2–3 years age subgroup; however, the ASD group showed no change with age growth. Shannon index
accounts for both abundance and evenness of species present. As shown in Figure 1(i), the Shannon index at the 4–6 years age subgroup showed no significant
change compared to the 2–3 years age subgroup, but the Shannon index at the subgroup of 7–11 years age in TD group showed increased compared to both
2–3 years and 4–6 years age subgroups, respectively. The phylogenetic diversity (PD) index was used to measure the degree of evolutionary divergence between two groups. As shown in Figure 1(j), the
PD index of the subgroup of 4–6 years and
7–11 years in TD group was increased compared to 2–3 subgroups, respectively.



**result** : 与TD组相比，C-ASD组的物种丰富度和多样性显著降低。

> Both species richness and diversity
were significantly lower in the C-ASD group than in
the TD group, as measured by breakaway and
Shannon index analyses (Figure 3(b,c)).

同样是南医大刘星吟团队发表在Gut Microbes的文章。

![image](http://210.75.224.110/github/MicrobiomeStatPlot/01AlphaBoxplot/2020GutMicrobes.fig1bc.png)

图5. 在门 （b）和属 （c）水平评估微生物群落丰富度。

示例二和示例三均来自同一文章，所以接下来我一并流程本文中关于alpha多样性的摘要，讨论和结论部分内容，方便大家做一个宏观了解。


**Abstract** ： 孤独症组（ASD）的α多样性系数随着年龄的增加无显著的变化，而健康组（TD）的α多样性系数同年龄呈正相关，暗示孤独症患者肠道菌群发育处于相对停滞的状态。
> We found that the α-diversity of ASD group showed no significant change with age, while the TD
group showed increased α-diversity with age, which indicates that the compositional development
of the gut microbiota in ASD varies at different ages in ways that are not consistent with TD
group.

**Discussion** ： 另外：ASD组幼儿的结果表明alpha多样性并没有年龄相关的变化。NC-ASD组降低了alpha多样性，并改变了微生物组成。但是，C-ASD组增加了alpha多样性，并进一步暗示便秘可能会增加肠道微生物异质性。

> In addition, the
α-diversity of ASD children showed no age-related
change, while TD children showed increased α-
diversity with age. NC-ASD showed decreased α-
diversity and alternation of gut microbiota compared
to TD.However, C-ASD showed increased α-diversity
compared to NC-ASD, which further implicated that
constipation might add heterogenous characteristics
of gut microbiota in ASD.

**Conclusion** : ASD组随着年龄的增加，其α多样性没有变化，而TD组α多样性随着年龄增长而增加，这提示ASD组的菌群发育可能处于相对停滞的状态。
> Moreover, the α-diversity in the gut
microbiota of ASD group showed no significant
change with age; however, the TD group showed
incre

**附图注原文：**
> (b) The estimate of richness index analysis between two groups at the level
of Phylum (b) and genus (c).


### 箱线图绘图实战

- 安装和加载R包：amplicon

从github上安装开发包；

```{R}
# 基于github安装
# library(devtools)  
# install_github("microbiota/amplicon")
```

如果R安装包存在问题。可以在宏基因组公众号后台回复"amplicon"，获得R 3.6版本的包合集下载链接。如Windows 10用户R包默认位置为 `文档 - R - win-library - 3.6`目录，解压后替换3.6文件夹即可完成安装。

载入R包

```{R}
suppressWarnings(suppressMessages(library(amplicon)))
```

- 数据读取和参数设定

这里有几个概念我们必须明确，由于我们的分析统计最终绝大多数在文章中表现为图片，所以需对文章中图形的布局和大小做一个简单的认识。

文章中纸图片尺寸为单栏89 mm，双栏183 mm，页面最宽为247 mm，这里刘老师推荐比例16：10，即半版89 mm x 56 mm; 183 mm x 114 mm。

这里我还是要感叹感叹，绘图高手不一定是发文章高手，因为有数不清的细节需要学习注意，这就是其中之一。

```{R}
# Data reading
metadata = read.table("./data/metadata.tsv", header=T, row.names=1, sep="\t", comment.char="", stringsAsFactors = F)
head(metadata, n = 3)
# colnames of group ID in metadata
# 设置实验分组列名
group = "Group"
# Output figure width and height  
# Letter纸图片尺寸为单栏89 mm，双栏183 mm，页面最宽为247 mm
# 推荐比例16：10，即半版89 mm x 56 mm; 183 mm x 114 mm
width = 89
height = 59

#--创建alpha文件夹用于结果保存

dir.create("./alpha")
# 手动指定分组列和顺序，默认为字母顺序
# metadata[[group]] = factor(metadata[[group]], levels = c("WT","KO","OE"))
# 按实验设计中分组出现顺序
# metadata[[group]] = factor(metadata[[group]], levels = unique(metadata[[group]]))

```

- 箱线图+统计 Boxplot+Statistics(alpha_boxplot)

使用?alpha_boxplot查看函数功能和用法，本函数支持14种alpha多样性指标，并将结果调用方差分析进行统计检验，使用TukeyHSD函数进行多重比较。最后使用箱线图进行可视化。

绘制主要分三步：

Plotting each figure mainly include three step:

1. 读取数据并预览格式Reading data and viewing format;
2. 参数调整和绘图Paramters adjustment and plotting;
3. 保存图片Saving figure.

```{r}

# vegan.txt中还有6种常用α多样性，alpha.txt中有11种α多样性
alpha_div = read.table("./data/vegan.txt", header=T, row.names=1, sep="\t", comment.char="")
head(alpha_div, n = 3)
# capitalize
library(Hmisc)
colnames(alpha_div) = capitalize(colnames(alpha_div))
colnames(alpha_div)
# 选择指数"Richness","Chao1","ACE","Shannon","Simpson","Invsimpson"  
alpha_index = "Richness"

# Plotting alpha diversity Richness boxplot and stat
(p = alpha_boxplot(alpha_div, index = alpha_index, metadata, groupID = group))

# Saving figure
# 保存图片，大家可以修改图片名称和位置，长宽单位为毫米

ggsave(paste0("alpha/alpha_boxplot_",alpha_index,".pdf"), p, width = width, height = height, units = "mm")

# 另存图片用于后期拼图
p1 = p

# 尝试探索不同的多样性各类
colnames(alpha_div)
alpha_boxplot(alpha_div, index = "Shannon", metadata, groupID = group)

# 尝试不同的分组方式
colnames(metadata)
alpha_boxplot(alpha_div, index = "Chao1", metadata, groupID = "Site")
```
![image](https://note.youdao.com/yws/public/resource/ea13d1c093132d45ad61c842e0912978/xmlnote/6593965147F44067A34D38F190FA313E/46163)


- 误差棒图+统计(alpha_barplot)

使用?alpha_barplot查看函数功能和用法，本函数支持14种alpha多样性指标，并将结果调用方差分析进行统计检验，使用TukeyHSD函数进行多重比较。最后使用柱状图进行可视化。在主题功能上和上一个函数一样，只是修改了可视化的部分。

这给了我们另外的一种可视化alpha多样性的选择。其实柱状图及近年来在高水平文章种出现的次数越来越少了，尤其是单独作为文章正图或者一部分，因为从功能上来讲只能展示均值和方差，不如箱线图结合散点展示的多。最近在一篇NBT上看到将柱状图结合散点和误差线进行展示，解决的这种弊端。可能在接下来的使用中更多一些。



```{R}
# vegan.txt中还有6种常用α多样性，alpha.txt中有11种α多样性
alpha_div = read.table("./data/vegan.txt", header=T, row.names=1, sep="\t", comment.char="")
head(alpha_div, n = 3)
# capitalize
library(Hmisc)
colnames(alpha_div) = capitalize(colnames(alpha_div))
colnames(alpha_div)
# 选择指数"Richness","Chao1","ACE","Shannon","Simpson","Invsimpson"  
alpha_index = "Richness"

# Plotting alpha diversity Richness boxplot and stat
(p = alpha_barplot(alpha_div, index = alpha_index, metadata, groupID = group))

# Saving figure
# 保存图片，大家可以修改图片名称和位置，长宽单位为毫米

ggsave(paste0("alpha/alpha_barplot_",alpha_index,".pdf"), p, width = width, height = height, units = "mm")

# 另存图片用于后期拼图
p1 = p

# 尝试探索不同的多样性各类
colnames(alpha_div)
alpha_barplot(alpha_div, index = "Shannon", metadata, groupID = group)

# 尝试不同的分组方式
colnames(metadata)
alpha_barplot(alpha_div, index = "Chao1", metadata, groupID = "Site")
```

![image](https://note.youdao.com/yws/public/resource/ea13d1c093132d45ad61c842e0912978/xmlnote/179E028BBE244575AB1D8DCF724253D5/46165)


### Reference

1. Xu-Bo Qian, Tong Chen, Yi-Ping Xu, Lei Chen, Fu-Xiang Sun, Mei-Ping Lu & Yong-Xin Liu. A guide to human microbiome research: study design, sample collection, and bioinformatics analysis. Chin. Med. J., doi:10.1097/CM9.0000000000000871 (2020).
2. Shannon, C.E. (1948). A mathematical theory of communication. The Bell System Technical Journal 27, 379-423.
1. Simpson, E.H. (1949). Measurement of Diversity. Nature 163, 688.
1. Chao, A., and Yang, M.C.K. (1993). Stopping rules and estimation for recapture debugging with unequal failure rates. Biometrika 80, 193-201.
1. Chao, A. (1984). Nonparametric Estimation of the Number of Classes in a Population. Scandinavian Journal of Statistics 11, 265-270.
1. 刘尧博客：http://wap.sciencenet.cn/blog-3406804-1179809.html?mobile=1
1. 百度百科箱形图：https://baike.baidu.com/item/%E7%AE%B1%E5%BD%A2%E5%9B%BE
1. Zhang, et.al. Transporter NTR1.1B contributes the association of root microbiota and nitrogen use in rice. 2019. Nature Biotechnology. doi: http://doi.org/10.1038/s41587-019-0104-4
1. Zhou Dan, Xuhua Mao, Qisha Liu, Mengchen Guo, Yaoyao Zhuang, Zhi Liu, Kun Chen, Junyu Chen, Rui Xu, Junming Tang, Lianhong Qin, Bing Gu, Kangjian Liu, Chuan Su, Faming Zhang, Yankai Xia, Zhibin Hu & Xingyin Liu. Altered gut microbial profile is associated with abnormal metabolism activity of Autism Spectrum Disorder. Gut Microbes, 1-22, doi:10.1080/19490976.2020.1747329 (2020).
